---
How Maliciously Crafted Images Spread Malware
---
<article class="post-listing post-16793 post type-post status-publish format-standard has-post-thumbnail hentry  tag-crafted tag-images tag-maliciously tag-malware tag-spread">
    <div class="post-inner">
        <span>Posted by: <a href="https://www.deepdotweb.com/author/filipjelic/" title="">Filip Jelic </a></span>
    <span>December 7, 2016</span>
    
    <span><a href="https://www.deepdotweb.com/2016/12/07/maliciously-crafted-images-spread-malware/#comments">2 Comments</a></span>
    </p>
    <div class="clear"></div>
    
    <p>Too many people got infected with &#8216;Locky&#8217; ransomware recently so it got my attention. Without investigating the malware itself, I&#8217;m going to analyze the attack vector that distributed Locky through Facebook messenger via an image file! Locky distributors also used MS Office Word documents to spread their evilness in similar fashion which may be covered in another article soon.</p>
    <p>On Facebook and LinkedIn Locky spreads via SVG images. Once it affects a victim, it shares the same image to all their friends. An image file from your trusted friend isn&#8217;t suspicious to most people. If you&#8217;re one of them, this will (hopefully) change now. I should mention that opening this image is not enough for the malware to execute, but it leads to it – read on.</p>
    <p><strong>SVG Images </strong></p>
    <p>Scaled Vector Graphics (.svg extension) is an image format from 1999. which is supported by all major browsers today. Take a look at simple .svg example:</p>
    <p><img class="wp-image-16798 aligncenter" src="/imgs/2016/12/word-image-10.png" srcset="/imgs/2016/12/word-image-10.png 820w, /imgs/2016/12/word-image-10-300x21.png 300w" sizes="(max-width: 820px) 100vw, 820px"/></p>
    <p>This code snippet is fairly self-explaining, here is how browsers render it:</p>
    <p><img class="wp-image-16799 aligncenter" src="/imgs/2016/12/word-image-11.png"/></p>
    <p><strong>Why did malware authors choose SVG images?</strong></p>
    <p>SVG is XML format which means that it can contain embedded content such as <strong>JavaScript</strong> (&lt;script&gt; tag) which can be opened in the browser directly. Thus, hackers can use wide JavaScript possibilities concealed in an image.</p>
    <p>Before opening .svg image with your browser, you can take a look at the code behind it by opening it with a text editor. For example, each instance of Locky&#8217;s script is obfuscated – each string that can be randomized is changed with each infection. Here&#8217;s one instance:</p>
    <p><a href="http://pastebin.com/BWxLgaVs">http://pastebin.com/BWxLgaVs</a></p>
    <p><strong>Brief Explanation</strong></p>
    <p>In our example, hackers have added a JavaScript code inside the image file which redirects you to a malicious website mimicking YouTube. Then the site pushes a popup, asking you to download and install a certain Google Chrome extension (it keeps getting new names as the old ones are removed) in order to view the video.</p>
    <p><img class="wp-image-16800 aligncenter" src="/imgs/2016/12/inserting-image-.png" alt="Inserting image..." width="1044" height="587" srcset="/imgs/2016/12/inserting-image-.png 1432w, /imgs/2016/12/inserting-image--300x169.png 300w, /imgs/2016/12/inserting-image--1024x576.png 1024w" sizes="(max-width: 1044px) 100vw, 1044px"/></p>
    <p>The malicious extension gives the attackers ability to read and modify all data on websites victim visits, which is used to send the same .svg image to all their Facebook friends. Immediately upon installation, extensions downloads and executes several background scripts.</p>
    <p>One of those scripts periodically redirects the victim to a website which automatically downloads Locky ransomware or other malware.</p>
    <p><strong>SVG Code Analysis</strong></p>
    <p>First few lines are all good, friendly little red circle:</p>
    <p><img class="wp-image-16801 aligncenter" src="/imgs/2016/12/word-image-12.png" srcset="/imgs/2016/12/word-image-12.png 824w, /imgs/2016/12/word-image-12-300x42.png 300w" sizes="(max-width: 824px) 100vw, 824px"/></p>
    <p>Then, there&#8217;s the fun part – JavaScript. First, there is <strong>jxnpgmlk </strong>function which acts as a decrypter (aka stub) for input string. Then there are these lines in which the function is called several times: <img class="wp-image-16802 aligncenter" src="/imgs/2016/12/word-image-13.png" srcset="/imgs/2016/12/word-image-13.png 763w, /imgs/2016/12/word-image-13-300x81.png 300w" sizes="(max-width: 763px) 100vw, 763px"/></p>
    <p>Exact algorithm used is not important because we can use a simple trick to see what exactly it does. I modified the code to make it print out values of variables: cujnl, gnqrek, zvlgj and yaqjv by using console.log command and this is the result:</p>
    <p>Variable cujnl = &#8220;top&#8221;, gnqrek = &#8220;location&#8221;, zvlgj = &#8220;href&#8221; and yaqjv[cujnl][gnqrek][zvlgj] = &#8220;<a href="http://mourid.com/php/trust.php">http://mourid.com/php/trust.php</a>&#8221; . The script directs to that websites which then redirects the victim a few times to a copy of Youtube as you can see on the image above. In my case it was called <a href="http://vepetamev.specialvideo.news/zidelevuzo.html">http://vepetamev.specialvideo.news/zidelevuzo.html</a>. Just like the extensions, these website addresses change frequently.</p>
    <p>If the victim accepts the malicious extension, the goal is achieved. Hackers behind it can read and modify all browser data and it&#8217;s game-over? Let&#8217;s take a look at what this extension does.</p>
    <p><strong>Browser Extension Analysis</strong></p>
    <p>I downloaded this extension for close inspection, but of course it&#8217;s heavily obfuscated. As mentioned above, extension downloads and executes several <a href="https://developer.chrome.com/extensions/background_pages">background pages</a> from the attacker.</p>
    <p>&#8220;A common need for extensions is to have a single long-running script to manage some task or state. Background pages to the rescue.&#8221; (…) &#8220;It exists for the lifetime of your extension&#8221;</p>
    <p>This is the code that downloads and executes long-running background scripts: <img class="wp-image-16803 aligncenter" src="/imgs/2016/12/word-image-14.png" srcset="/imgs/2016/12/word-image-14.png 764w, /imgs/2016/12/word-image-14-300x119.png 300w" sizes="(max-width: 764px) 100vw, 764px"/></p>
    <p>This way, scripts can be changed at any time if hackers get a different interest. For now, background scripts further distribute the malware to victim&#8217;s Facebook friends and redirect to their malicious websites, often resulting in Locky ransomware installation.</p>
    <p><strong>Conclusion</strong></p>
    <p>SVG images are viable attack vector due to their non-threatening reputation, but they require a few more user clicks to execute a ransomware-like malware. Browser extension can spy on you which is big enough problem itself, but also results in downloading and executing other malware. I think that extension&#8217;s permission: &#8220;read and change all your data on websites you visit&#8221; should raise a flag even in non tech-savvy people, but sadly it seems to not be the case.</p>
    </div>
    <a href="https://www.deepdotweb.com/tag/crafted/" rel="tag">crafted</a> <a href="https://www.deepdotweb.com/tag/images/" rel="tag">images</a> <a href="https://www.deepdotweb.com/tag/maliciously/" rel="tag">maliciously</a> <a href="https://www.deepdotweb.com/tag/malware/" rel="tag">malware</a> <a href="https://www.deepdotweb.com/tag/spread/" rel="tag">spread</a></span> <span style="display:none" class="updated">2016-12-07</span>
    <div style="display:none" class="vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person"><strong class="fn" itemprop="name"><a href="https://www.deepdotweb.com/author/filipjelic/" title="Posts by Filip Jelic" rel="author">Filip Jelic</a></strong></div>
    
