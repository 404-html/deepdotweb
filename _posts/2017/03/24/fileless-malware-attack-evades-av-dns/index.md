---
Fileless Malware Attack Evades AV with DNS
---
<article class="post-listing post-18766 post type-post status-publish format-standard has-post-thumbnail hentry category-articles category-deepdot-news tag-attack tag-av tag-dns tag-evades tag-fileless tag-malware">
<div class="post-inner">
<p class="post-meta">
<span>Posted by: <a href="https://www.deepdotweb.com/author/filipjelic/" title="">Filip Jelic </a></span>
<span>March 24, 2017</span>
<span>in <a href="https://www.deepdotweb.com/category/articles/" rel="category tag">Articles</a>, <a href="https://www.deepdotweb.com/category/deepdot-news/" rel="category tag">Featured</a></span>
<span><a href="https://www.deepdotweb.com/2017/03/24/fileless-malware-attack-evades-av-dns/#respond">Leave a comment</a></span>
</p>
<div class="clear"></div>
<div class="entry">
<p>Malware authors never fail to find new ways of doing the same thing to go under the AV&#8217;s radar. Recently, Cisco&#8217;s security researchers team <a href="http://blog.talosintelligence.com/2017/03/dnsmessenger.html">Talos</a> spotted a novelty in controlling exploited computers. Dubbed DNSMessenger, it&#8217;s a Remote Administration Tool (RAT) that used DNS to communicate with Command &amp; Control server.</p>
<p>DNSMessenger Infection Chain</p>
<p>Even though attack vector includes a file, attack is executed completely in memory and doesn&#8217;t leave a trace on the disk.</p>
<ol>
<li>Document &#8220;secured by McAfee&#8221;</li>
</ol>
<p>First step is opening Microsoft Word document with malicious Visual Basic for Applications (VBA) macro. Check <a href="https://www.deepdotweb.com/2016/12/15/dangers-doc-ms-word-documents/">this</a> if you want to know more about Word documents as attack vector.</p>
<p>There&#8217;s a nice fake message removing in attempt to encourage people to allow macros.</p>
<p><img class="wp-image-18774 aligncenter" src="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-52.png" srcset="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-52.png 641w, https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-52-300x225.png 300w" sizes="(max-width: 641px) 100vw, 641px" /></p>
<ol>
<li>Getting PowerShell</li>
</ol>
<p>VBA script uses Windows native tool PowerShell for administration and communication with the Command &amp; Control Server. VBA script runs a Create method to run PowerShell in the Windows Management Instrumentation (<a href="https://msdn.microsoft.com/en-us/library/bb742445.aspx">WMI</a>) Win32_Process object.</p>
<p>Script adapts itself to the surroundings, mainly based on privileges of the exploited user and version of PowerShell. This is done in &#8216;pre_logic&#8217; function below (deobfuscated code by Talos).</p>
<p><img class="wp-image-18775 aligncenter" src="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-53.png" srcset="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-53.png 640w, https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-53-300x91.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>Based on the two switches, malware will decide whether to execute and add persistence. In addition to the switches, the function contains five parameters which are used to determine what subdomains to use when sending DNS TXT record queries in the next stage.</p>
<ol>
<li>Making itself at home</li>
</ol>
<p>Based on the privileges of the exploited user (switch $add_persistence), PowerShell script will choose appropriate registry key:</p>
<p>If Administrator is exploited:</p>
<ul>
<li>$reg_win_path: &#8220;HKLM:Software\Microsoft\Windows\CurrentVersion&#8221;</li>
<li>$reg_run_path: &#8220;HKLM:Software\Microsoft\Windows\CurrentVersion\Run\&#8221;</li>
</ul>
<p>If &#8216;regular&#8217; user is exploited:</p>
<ul>
<li>$reg_win_path: &#8220;HKCU:Software\Microsoft\Windows&#8221;</li>
<li>$reg_run_path: &#8220;HKCU:Software\Microsoft\Windows\CurrentVersion\Run\&#8221;</li>
</ul>
<p>Script then randomly chooses a domain to use for DNS from an array of hardcoded domains to perform initial DNS lookup. The contents of DNS TXT record from the both query and the response contain the synchronization information (SYN on diagram).</p>
<p><img class="wp-image-18776 aligncenter" src="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-14.jpeg" srcset="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-14.jpeg 640w, https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-14-300x166.jpeg 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<ol>
<li>Remote Access</li>
</ol>
<p>At this moment, persistence is done and PowerShell Win32_Process is ready to receive commands through DNS TXT records. Exploited machine now sends DNS queries to receive the command (MSG on diagram). Here&#8217;s an instance of receiving command, captured by Wireshark:</p>
<p><img class="wp-image-18777 aligncenter" src="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-54.png" srcset="https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-54.png 640w, https://www.deepdotweb.com/wp-content/uploads/2017/03/word-image-54-300x114.png 300w" sizes="(max-width: 640px) 100vw, 640px" /></p>
<p>String is reassembled, decompressed, base64 decoded into a cmd.exe command by PowerShell. The system is effectively owned by using PowerShell and DNS. Original communication channel helped a lot with AV heuristics check. Combined with the fact that attack is fileless, it was evasive for all AVs.</p>
<p>Although it wasn&#8217;t spotted in this exact malware, DNS-based RAT can also receive and run executable files via DNS TXT queries, just like conventional backdoors.</p>
<p>Conclusion</p>
<p>Malware authors frequently find innovations which put anti-virus opposition in tough spot. This sample is a great example why all internet traffic should be investigated when looking for malware.</p>
</div>
<span style="display:none"><a href="https://www.deepdotweb.com/tag/attack/" rel="tag">attack</a> <a href="https://www.deepdotweb.com/tag/av/" rel="tag">av</a> <a href="https://www.deepdotweb.com/tag/dns/" rel="tag">dns</a> <a href="https://www.deepdotweb.com/tag/evades/" rel="tag">evades</a> <a href="https://www.deepdotweb.com/tag/fileless/" rel="tag">fileless</a> <a href="https://www.deepdotweb.com/tag/malware/" rel="tag">malware</a></span> <span style="display:none" class="updated">2017-03-24</span>
<div style="display:none" class="vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person"><strong class="fn" itemprop="name"><a href="https://www.deepdotweb.com/author/filipjelic/" title="Posts by Filip Jelic" rel="author">Filip Jelic</a></strong></div>
</div>
</article>

